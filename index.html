<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rural vs Urban Environment Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  *{
    box-sizing:border-box;
  }
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    color:white;
    padding:12px;
  }
  h1{
    text-align:center;
    margin:10px 0 16px;
    font-size:clamp(18px,4vw,26px);
  }
  .grid{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  @media (min-width:768px){
    body{padding:20px;}
    .grid{
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:20px;
    }
  }
  .card{
    background:rgba(255,255,255,0.12);
    backdrop-filter:blur(10px);
    border-radius:16px;
    padding:12px;
    box-shadow:0 8px 20px rgba(0,0,0,0.3);
  }
  .chart-container{
    position:relative;
    width:100%;
    height:260px;
  }
  @media (min-width:768px){
    .chart-container{
      height:340px;
    }
  }
  canvas{
    background:rgba(0,0,0,0.2);
    border-radius:12px;
  }
</style>
</head>

<body>

<h1>üåç Rural vs Urban Environment Dashboard</h1>

<div class="grid">
  <div class="card">
    <div class="chart-container">
      <canvas id="tempChart"></canvas>
    </div>
  </div>

  <div class="card">
    <div class="chart-container">
      <canvas id="humChart"></canvas>
    </div>
  </div>
</div>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbyJnyIqeha3gcOw63sYoZVthoOnXXWnITMdMmj_3Zf48SJlp4Mg7rfQusZzC6ZOKsu4/exec";

let tempChart, humChart;

// Format ISO-like datetime string from Sheets to "dd/mm hh:mm"
function formatLabel(raw){
  const d = new Date(raw);
  const datePart = d.toLocaleDateString('en-GB', {
    day: '2-digit',
    month: '2-digit'
  });
  const timePart = d.toLocaleTimeString('en-GB', {
    hour: '2-digit',
    minute: '2-digit'
  });
  return `${datePart} ${timePart}`; // e.g. "14/12 22:11"
}
/*
async function loadData(){
  const ruralRes  = await fetch(DATA_URL + "?location=rural");
  const ruralData = await ruralRes.json();

  const urbanRes  = await fetch(DATA_URL + "?location=urban");
  const urbanData = await urbanRes.json();

  ruralData.shift();
  urbanData.shift();

  let labels = [];
  let ruralT = [], ruralH = [];
  let urbanT = [], urbanH = [];

  ruralData.forEach(row => {
    const time = row[1];
    const temp = row[3];
    const hum  = row[4];

    labels.push(formatLabel(time));
    ruralT.push(temp);
    ruralH.push(hum);
    urbanT.push(null);
    urbanH.push(null);
  });

  urbanData.forEach(row => {
    const time = row[1];
    const temp = row[3];
    const hum  = row[4];

    labels.push(formatLabel(time));
    urbanT.push(temp);
    urbanH.push(hum);
    ruralT.push(null);
    ruralH.push(null);
  });

  updateCharts(labels, ruralT, urbanT, ruralH, urbanH);
}
*/
async function loadData(){
  const ruralRes  = await fetch(DATA_URL + "?location=rural");
  const ruralData = await ruralRes.json();

  const urbanRes  = await fetch(DATA_URL + "?location=urban");
  const urbanData = await urbanRes.json();

  ruralData.shift();
  urbanData.shift();

  // Create maps using time as key
  const ruralMap = {};
  const urbanMap = {};

  ruralData.forEach(row => {
    const time = formatLabel(row[1]);
    ruralMap[time] = {
      temp: row[3],
      hum:  row[4]
    };
  });

  urbanData.forEach(row => {
    const time = formatLabel(row[1]);
    urbanMap[time] = {
      temp: row[3],
      hum:  row[4]
    };
  });

  // Union of all timestamps
  const labels = [...new Set([
    ...Object.keys(ruralMap),
    ...Object.keys(urbanMap)
  ])].sort();

  let ruralT = [], urbanT = [];
  let ruralH = [], urbanH = [];

  labels.forEach(time => {
    ruralT.push(ruralMap[time]?.temp ?? null);
    ruralH.push(ruralMap[time]?.hum  ?? null);
    urbanT.push(urbanMap[time]?.temp ?? null);
    urbanH.push(urbanMap[time]?.hum  ?? null);
  });

  

 updateCharts(labels, ruralT, urbanT, ruralH, urbanH);
}

function createCharts(){
  tempChart = new Chart(document.getElementById("tempChart"),{
    type:"line",
    data:{
      labels:[],
      datasets:[
        {label:"Rural Temperature (¬∞C)",data:[],borderColor:"#1eff72",spanGaps:true},
        {label:"Urban Temperature (¬∞C)",data:[],borderColor:"#ff4b4b",spanGaps:true}
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ticks:{maxTicksLimit:5}}
      },
      plugins:{
        legend:{labels:{boxWidth:10,font:{size:11}}}
      }
    }
  });

  humChart = new Chart(document.getElementById("humChart"),{
    type:"line",
    data:{
      labels:[],
      datasets:[
        {label:"Rural Humidity (%)",data:[],borderColor:"#00e5ff",spanGaps:true},
        {label:"Urban Humidity (%)",data:[],borderColor:"#ffd700",spanGaps:true}
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ticks:{maxTicksLimit:5}}
      },
      plugins:{
        legend:{labels:{boxWidth:10,font:{size:11}}}
      }
    }
  });
}

function updateCharts(labels,rT,uT,rH,uH){
  tempChart.data.labels = labels;
  tempChart.data.datasets[0].data = rT;
  tempChart.data.datasets[1].data = uT;
  tempChart.update();

  humChart.data.labels = labels;
  humChart.data.datasets[0].data = rH;
  humChart.data.datasets[1].data = uH;
  humChart.update();
}

createCharts();
loadData();
setInterval(loadData,100000);
</script>

</body>
</html>
